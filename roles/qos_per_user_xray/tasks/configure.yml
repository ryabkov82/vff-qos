- name: QoS | Create required directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ qos_etc_dir }}"
    - "{{ qos_log_dir }}"
    - "{{ qos_state_dir }}"

- name: QoS | Render environment file
  ansible.builtin.template:
    src: qos.env.j2
    dest: "{{ qos_etc_dir }}/qos.env"
    mode: "0644"
  notify: QoS | Restart qos-follow service

- name: QoS | Install follow script (static)
  ansible.builtin.copy:
    src: qos_follow_xray_email.sh
    dest: "{{ qos_bin_dir }}/qos_follow_xray_email.sh"
    mode: "0755"
    owner: root
    group: root
  notify: QoS | Restart qos-follow service

- name: QoS | Install tc/ifb bootstrap script (static)
  ansible.builtin.copy:
    src: qos_bootstrap_tc.sh
    dest: "{{ qos_bin_dir }}/qos_bootstrap_tc.sh"
    mode: "0755"
    owner: root
    group: root
  when: qos_tc_enable | bool

# --- QoS GC ---
- name: QoS | Install tc GC script (static)
  ansible.builtin.copy:
    src: qos_gc_tc.sh
    dest: "{{ qos_bin_dir }}/qos_gc_tc.sh"
    mode: "0755"
    owner: root
    group: root
  tags: [qos_gc]

# --- nft runtime ctmark -> fwmark (Docker-safe) ---

- name: QoS | Render nftables QoS snippet into include dir (reference only)
  ansible.builtin.template:
    src: nftables-include-qos-ctmark.nft.j2
    dest: "{{ qos_nft_snippet_path }}"
    mode: "0644"
  when:
    - qos_nft_manage | bool
    - qos_state == "present"

- name: QoS | Install nft runtime apply script (static)
  ansible.builtin.copy:
    src: vff-qos-nft-apply.sh
    dest: "{{ qos_nft_apply_script_path }}"
    mode: "0755"
    owner: root
    group: root
  when:
    - qos_nft_manage | bool
    - qos_state == "present"
  notify: QoS | Restart vff-qos-nft service

- name: QoS | Apply nft runtime rules now (ct mark -> skb mark)
  ansible.builtin.command: "{{ qos_nft_apply_script_path }}"
  environment:
    QOS_NFT_FAMILY: "{{ qos_nft_table_family }}"
    QOS_NFT_TABLE: "{{ qos_nft_table_name }}"
    QOS_NFT_CHAIN_PRE: "{{ qos_nft_chain_prerouting }}"
    QOS_NFT_CHAIN_OUT: "{{ qos_nft_chain_output }}"
  register: qos_nft_apply_now
  changed_when: false
  failed_when: false
  when:
    - qos_nft_manage | bool
    - qos_state == "present"
